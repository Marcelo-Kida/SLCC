CREATE OR REPLACE PROCEDURE A6PROC.A6P_ATUALIZA_POSI_DISP (
	P_CO_GRUP_VEIC_LEGA		A8.TB_VEIC_LEGA.CO_GRUP_VEIC_LEGA%TYPE,
	P_CO_VEIC_LEGA			A8.TB_VEIC_LEGA.CO_VEIC_LEGA%TYPE,
	P_SG_SIST			A8.TB_VEIC_LEGA.SG_SIST%TYPE)			IS
	
	CURSOR cVeic(P_AUX_DT_CAIX_DISP		DATE)
		IS
		SELECT	A.CO_VEIC_LEGA,
			A.SG_SIST,
			DECODE(B.CO_VEIC_LEGA, NULL, 0, 1)	IN_CTRL
		FROM	A8.TB_VEIC_LEGA			A,
			A6.TB_POSI_CAIX_DISP		B
		WHERE	A.SG_SIST		= B.SG_SIST		(+)
		AND	A.CO_VEIC_LEGA		= B.CO_VEIC_LEGA	(+)
		AND	((B.CO_VEIC_LEGA	IS NULL)
		OR	 (B.CO_VEIC_LEGA	IS NOT NULL
		AND	  B.CO_SITU_CAIX	= 1
		AND	  B.DT_CAIX_DISP	< P_AUX_DT_CAIX_DISP))
		AND	A.CO_GRUP_VEIC_LEGA	= DECODE(P_CO_GRUP_VEIC_LEGA, 0, A.CO_GRUP_VEIC_LEGA, P_CO_GRUP_VEIC_LEGA)
		AND	A.CO_VEIC_LEGA		= DECODE(P_CO_VEIC_LEGA, '', A.CO_VEIC_LEGA, P_CO_VEIC_LEGA)
		AND	A.SG_SIST		= DECODE(P_SG_SIST, '', A.SG_SIST, P_SG_SIST);
		
	v_DT_CAIX_DISP		DATE;
BEGIN
	A8PROC.A8P_ADICIONA_DIAS_UTEIS(SYSDATE, 0, 1, v_DT_CAIX_DISP);
	v_DT_CAIX_DISP := TO_DATE(TO_CHAR(v_DT_CAIX_DISP, 'DD/MM/YYYY'), 'DD/MM/YYYY');
	
	FOR cAux IN cVeic(v_DT_CAIX_DISP) LOOP
		BEGIN
			IF cAux.IN_CTRL = 0 THEN
				INSERT INTO A6.TB_POSI_CAIX_DISP (
					SG_SIST,
					CO_VEIC_LEGA,
					DT_CAIX_DISP,
					CO_SITU_CAIX,
					VA_UTLZ_ABER_CAIX)
				VALUES (cAux.SG_SIST,
					cAux.CO_VEIC_LEGA,
					v_DT_CAIX_DISP,
					1,		-- Disponível
					0);
			ELSE
				UPDATE	A6.TB_POSI_CAIX_DISP
				SET	DT_CAIX_DISP		= v_DT_CAIX_DISP,
					CO_SITU_CAIX		= 1,
					VA_UTLZ_ABER_CAIX	= 0
				WHERE	SG_SIST			= cAux.SG_SIST
				AND	CO_VEIC_LEGA		= cAux.CO_VEIC_LEGA;
			END IF;
		EXCEPTION
			WHEN OTHERS THEN
				NULL;
		END;
	END LOOP;
EXCEPTION
	WHEN OTHERS THEN
		NULL;
END;
/
